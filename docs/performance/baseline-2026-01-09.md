# Performance Baseline - 2026-01-09

## System Information

```
CPU:           Intel(R) Xeon(R) CPU E5-2699 v3 @ 2.30GHz
Cores:         36 (2 sockets × 18 cores, no hyperthreading)
CPU Max MHz:   3600.0000
L1d Cache:     1.1 MiB (36 instances)
L2 Cache:      9 MiB (36 instances)
L3 Cache:      90 MiB (2 instances, 45 MiB each)
NUMA:          2 nodes (0-17, 18-35)
```

## Baseline Benchmark Results

All benchmarks run with `cargo bench --release`.

### Phlogiston (Gas) Accounting

| Benchmark | Operations | Time | Throughput |
|-----------|------------|------|------------|
| charge_operations | 100 | 8.61 µs | 11.6 Melem/s |
| charge_operations | 1,000 | 87.1 µs | 11.5 Melem/s |
| charge_operations | 10,000 | 875 µs | 11.4 Melem/s |

**Notes:** Phlogiston charging maintains consistent ~11.5 Melem/s throughput.
SeqCst atomics may be limiting factor.

### Checkpoint Operations

| Benchmark | Channels | Items | Time | Throughput |
|-----------|----------|-------|------|------------|
| soft_checkpoint_create | 10 | 100 | 34.3 µs | 2.91 Melem/s |
| soft_checkpoint_revert | 10 | 100 | 34.2 µs | 2.92 Melem/s |
| soft_checkpoint_create | 100 | 1,000 | 35.2 µs | 28.4 Melem/s |
| soft_checkpoint_revert | 100 | 1,000 | 17.7 µs | 56.5 Melem/s |
| soft_checkpoint_create | 1,000 | 10,000 | 168.4 µs | 59.4 Melem/s |
| soft_checkpoint_revert | 1,000 | 10,000 | 90.1 µs | 110.9 Melem/s |

**Notes:** Revert is faster than create due to move semantics.
Checkpoint creation involves deep clone of state.

### Produce/Consume Cycles

| Benchmark | Operations | Time | Throughput |
|-----------|------------|------|------------|
| produce_only | 100 | 7.36 µs | 13.6 Melem/s |
| produce_only | 1,000 | 32.3 µs | 31.0 Melem/s |
| produce_only | 10,000 | 436.6 µs | 22.9 Melem/s |
| consume_immediate_match | 100 | 21.0 µs | 4.76 Melem/s |
| consume_immediate_match | 1,000 | 186.5 µs | 5.36 Melem/s |
| consume_immediate_match | 10,000 | 1.84 ms | 5.43 Melem/s |

**Notes:** Consume is ~4-5x slower than produce due to pattern matching.
Throughput drops at larger sizes due to linear matching.

### Multi-Channel Produce

| Benchmark | Channels | Time | Throughput |
|-----------|----------|------|------------|
| produce_multi_channel | 10 | 5.63 µs | 1.78 Melem/s |
| produce_multi_channel | 100 | 19.6 µs | 5.11 Melem/s |
| produce_multi_channel | 1,000 | 196.3 µs | 5.09 Melem/s |

**Notes:** Channel lookup overhead is significant at small counts.
HashMap amortizes well at larger scales.

### Atomic Ordering Comparison

| Ordering | Operation | Time (10K ops) | Throughput |
|----------|-----------|----------------|------------|
| SeqCst | fetch_add | 83.5 µs | 119.7 Melem/s |
| Release | fetch_add | 83.4 µs | 119.9 Melem/s |
| Relaxed | fetch_add | 83.2 µs | 120.2 Melem/s |
| SeqCst | compare_exchange | 97.8 µs | 102.2 Melem/s |
| Release | compare_exchange | 101.0 µs | 99.0 Melem/s |

**Notes:** On x86-64, atomic orderings have minimal impact due to
strong memory model. TSO provides SeqCst-like guarantees already.
Optimization potential ~0.5% for atomics.

## Key Bottlenecks Identified

1. **Pattern Matching (High Impact)**
   - Consume is 4-5x slower than produce
   - Linear search through continuations
   - Target: Parallel matching for large collections

2. **Checkpoint Creation (Medium Impact)**
   - Deep clone of space state
   - Target: Persistent data structures (im::Vector)

3. **Channel Lookup (Medium Impact)**
   - HashMap overhead at small scales
   - Target: DashMap for concurrent access

4. **Atomic Orderings (Low Impact on x86)**
   - Minimal difference on x86-64
   - May matter on ARM/other architectures

## Optimization Targets

Based on baseline, prioritize:

1. Phase 2: DashMap for concurrent access (8-10x expected under contention)
2. Phase 3: Persistent DS for checkpoints (5-10x for checkpoint create)
3. Phase 4: Parallel matching (linear scaling with cores)
4. Phase 1: Atomic orderings (marginal on x86, but correct regardless)

## How to Reproduce

```bash
# Full benchmark suite
cargo bench --bench spaces_benchmark

# Quick benchmark (used for this baseline)
cargo bench --bench spaces_benchmark -- "phlogiston|produce_consume|checkpoint" --quick

# With CPU affinity (recommended)
./scripts/benchmark-with-perf.sh --filter "phlogiston|produce_consume|checkpoint"
```

## Full Reports

HTML reports: `target/criterion/report/index.html`
